# Android 应用结构与优化审查

- 审查日期：2026-02-07
- 项目：`areyoulu-main`
- 范围：React + Vite + Capacitor(Android) 的结构、构建配置、隐私安全、性能与可维护性

## 总结

当前应用功能完整且可用（打卡、日历、统计、PIN 锁、CSV 导入导出、分享）。  
主要风险集中在隐私安全、离线稳定性与 Android 发布配置。

## 问题清单（按优先级）

### 高优先级

1. 运行时依赖外部 CDN 与远程资源，影响离线可用性，并产生第三方请求暴露。
- `index.html:8`
- `index.html:14`
- `index.html:16`
- `index.html:88`
- `index.html:93`
- `index.html:230`

2. PIN 和安全问题答案以明文存储，且“忘记 PIN”流程会直接显示 PIN。
> 注：该项已处理，PIN/安全答案已改为哈希存储，且“忘记 PIN”不再显示原 PIN，仅允许重置。
> **🔴 已完成**
- `components/SettingsView.tsx`（PIN 与安全答案改为哈希存储）
- `components/LockScreen.tsx`（哈希验证 + 旧明文迁移 + 移除展示原 PIN）
- `utils/secret.ts`（新增 PBKDF2 哈希与验证工具）


3. `GEMINI_API_KEY` 被注入到前端构建变量，存在被打包进客户端的风险。
> 注：该项已处理，已移除前端 API Key 注入。
> **🔴 已完成**
- `vite.config.ts`（已删除 `process.env.API_KEY` / `process.env.GEMINI_API_KEY` 注入）
- `README.md`（已删除 `GEMINI_API_KEY` 配置步骤）


4. Gradle 配置写死本机 JDK 路径，团队协作与 CI 环境易失败。
- `android/gradle.properties:15`

5. Android 备份开启（`allowBackup=true`），与“本地隐私”定位冲突。
- `android/app/src/main/AndroidManifest.xml:5`

### 中优先级

6. Android Release 构建未开启混淆压缩（`minifyEnabled false`），包体与逆向暴露面偏大。
- `android/app/build.gradle:25`

7. 导出路径依赖 `ExternalStorage` 与旧存储权限，在新 Android 版本上可能行为不稳定。
- `App.tsx:444`
- `App.tsx:454`
- `android/app/src/main/AndroidManifest.xml:41`
- `android/app/src/main/AndroidManifest.xml:42`

8. `localStorage.clear()` 会清空同域所有键，超出应用自身数据范围。
- `App.tsx:399`

9. CSV 导入解析较脆弱，且导入策略是直接追加，存在重复和脏数据风险。
- `components/SettingsView.tsx:143`
- `components/SettingsView.tsx:160`
- `App.tsx:622`

10. 前端包体偏大（主 chunk 超过 500kB 告警），`App.tsx` 也过于臃肿。
- `App.tsx:29`
- `App.tsx:549`
- `components/StatsView.tsx:2`

### 低优先级

11. 多个组件在运行时注入内联 `<style>`，增加渲染期样式开销与维护成本。
- `components/CalendarView.tsx:149`
- `components/DetailModal.tsx:67`
- `components/LockScreen.tsx:209`

## 已执行验证

- `npm run build`：通过（有大包告警）
- `npx tsc --noEmit`：通过
- `npx cap doctor`：Android 环境正常

## 建议修复顺序

1. 先做隐私与安全加固：
- 移除前端 API Key 注入。**🔴 已完成**
- 将明文 PIN/安全答案替换为更安全的存储方案，并移除直接展示 PIN 的流程。**🔴 已完成**
- 复核备份策略（`allowBackup` / data extraction rules）。

2. 再做离线与依赖治理：
- 将运行时 CDN/字体/图标/背景依赖替换为本地打包资源。

3. 再做 Android 发布就绪：
- 去掉硬编码 `org.gradle.java.home`。
- 调整导出存储路径策略以适配新 Android。
- 启用并验证 release 混淆压缩策略。

4. 最后做性能与可维护性：
- 拆分 `App.tsx` 的状态与业务逻辑到模块或 hooks。
- 加强 CSV 导入健壮性与去重。
- 将组件内联样式迁移到静态 CSS。
